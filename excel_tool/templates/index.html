{% extends "base.html" %}

{% block title %}首页 - Excel/CSV 汇总工具{% endblock %}

{% block extra_css %}
<style>
.drop-zone {
    border: 2px dashed #ccc;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    position: relative;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
    cursor: pointer;
}

.drop-zone:hover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.drop-zone.dragover {
    border-color: #28a745;
    background-color: #d4edda;
    transform: scale(1.02);
}

.drop-zone-content {
    pointer-events: none;
}

.drop-zone-icon {
    font-size: 3rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.drop-zone-title {
    color: #495057;
    margin-bottom: 0.5rem;
}

.drop-zone-subtitle {
    color: #6c757d;
    margin-bottom: 1rem;
}

.drop-zone-formats {
    font-size: 0.875rem;
    color: #6c757d;
}

.drop-zone-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(40, 167, 69, 0.9);
    border-radius: 8px;
    display: none;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    font-weight: bold;
}

.drop-zone.dragover .drop-zone-overlay {
    display: flex;
}

.drop-zone-overlay-content i {
    font-size: 2rem;
    margin-right: 0.5rem;
}

.selected-files-preview {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}

.selected-file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background-color: white;
    border-radius: 6px;
    margin-bottom: 8px;
    border: 1px solid #dee2e6;
}

.selected-file-info {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.selected-file-icon {
    margin-right: 8px;
    color: #007bff;
}

.selected-file-name {
    font-weight: 500;
    margin-right: 8px;
}

.selected-file-size {
    font-size: 0.875rem;
    color: #6c757d;
}

.selected-file-remove {
    color: #dc3545;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.selected-file-remove:hover {
    background-color: #f5c6cb;
}
</style>
{% endblock %}

{% block content %}
<!-- 使用方法说明 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> 使用方法
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="bi bi-1-circle"></i> 上传文件</h6>
                        <p class="small mb-3">支持 Excel (.xlsx, .xls) 和 CSV 文件，可同时上传多个文件进行合并处理。</p>
                        
                        <h6 class="text-primary"><i class="bi bi-2-circle"></i> 配置合并</h6>
                        <p class="small mb-3">选择工作表、设置表头行、配置数据清洗选项，预览合并效果。</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="bi bi-3-circle"></i> 开始处理</h6>
                        <p class="small mb-3">提交合并任务，系统自动处理数据并生成结果文件。</p>
                        
                        <h6 class="text-primary"><i class="bi bi-4-circle"></i> 下载结果</h6>
                        <p class="small mb-0">处理完成后下载 Excel 或 CSV 格式的合并结果文件。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cloud-upload"></i> 文件上传
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data" id="uploadForm">
                    <!-- 拖拽上传区域 -->
                    <div class="drop-zone mb-4" id="dropZone">
                        <div class="drop-zone-content">
                            <i class="bi bi-cloud-upload drop-zone-icon"></i>
                            <h5 class="drop-zone-title">拖拽文件到此处</h5>
                            <p class="drop-zone-subtitle">或点击下方按钮选择文件</p>
                            <div class="drop-zone-formats">
                                支持格式：Excel (.xlsx, .xls)、CSV | 单文件最大 10MB
                            </div>
                        </div>
                        <div class="drop-zone-overlay" id="dropOverlay">
                            <div class="drop-zone-overlay-content">
                                <i class="bi bi-plus-circle"></i>
                                <span>释放文件开始上传</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="files" class="form-label">或选择文件</label>
                        <input type="file" class="form-control" id="files" name="files" multiple 
                               accept=".xlsx,.xls,.csv">
                        <div class="form-text">
                            支持格式：.xlsx, .xls, .csv | 单文件最大 10MB | 总大小限制 100MB
                        </div>
                    </div>
                    
                    <!-- 文件夹上传选项 -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="folderMode" onchange="toggleFolderMode()">
                            <label class="form-check-label" for="folderMode">
                                <i class="bi bi-folder2-open"></i> 上传整个文件夹
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="clearSelectedFiles()">
                            <i class="bi bi-x-circle"></i> 清空选择
                        </button>
                        <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                            <i class="bi bi-upload"></i> 上传文件
                        </button>
                    </div>
                </form>
                
                <!-- 已选择文件预览 -->
                <div class="selected-files-preview mt-3" id="selectedFilesPreview" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted mb-0">已选择的文件：</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelectedFiles()" title="清空所有文件">
                            <i class="bi bi-trash"></i> 清空
                        </button>
                    </div>
                    <div class="selected-files-list" id="selectedFilesList"></div>
                </div>
                
                <!-- 上传进度 -->
                <div class="progress mt-3" id="uploadProgress" style="display: none;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 已上传文件列表 -->
{% if files %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-files"></i> 已上传文件 ({{ files|length }})
                </h5>
                <div>
                    <button class="btn btn-danger btn-sm me-2" onclick="clearAllFiles()" 
                            title="清理所有文件" id="clearAllBtn">
                        <i class="bi bi-trash3"></i> 清理所有
                    </button>
                    <button class="btn btn-success btn-sm" onclick="selectAllFiles()">
                        <i class="bi bi-check2-all"></i> 全选并合并
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>文件名</th>
                                <th>大小</th>
                                <th>工作表</th>
                                <th>上传时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="file-checkbox" value="{{ file.file_id }}">
                                </td>
                                <td>
                                    <i class="bi bi-file-earmark-{% if file.extension == 'csv' %}text{% else %}spreadsheet{% endif %}"></i>
                                    {{ file.original_filename }}
                                </td>
                                <td>{{ (file.file_size / 1024 / 1024) | round(2) }} MB</td>
                                <td>
                                    {% if file.sheets %}
                                        <span class="badge bg-info">{{ file.sheets|length }} 个</span>
                                        <small class="text-muted">({{ file.sheets|join(', ') }})</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ file.upload_time[:19].replace('T', ' ') }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="previewFile('{{ file.file_id }}', '{{ file.original_filename }}')">
                                            <i class="bi bi-eye"></i> 预览
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteFile('{{ file.file_id }}', '{{ file.original_filename }}')">
                                            <i class="bi bi-trash"></i> 删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button class="btn btn-success" onclick="configureSelectedFiles()" id="configureBtn">
                        <i class="bi bi-gear"></i> 配置选中文件
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-light">
            <div class="card-body text-center text-muted">
                <i class="bi bi-file-earmark-plus" style="font-size: 3rem;"></i>
                <h5 class="mt-3">暂无上传文件</h5>
                <p>请先上传 Excel 或 CSV 文件开始数据合并</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 文件预览模态框 -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-eye"></i> 文件预览
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">工作表</label>
                        <select class="form-select" id="previewSheet" onchange="updatePreview()">
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">表头行</label>
                        <input type="number" class="form-control" id="previewHeaderRow" 
                               value="0" min="0" onchange="updatePreview()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">预览行数</label>
                        <input type="number" class="form-control" id="previewRows" 
                               value="20" min="5" max="100" onchange="updatePreview()">
                    </div>
                </div>
                
                <div id="previewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedFiles = [];
let currentPreviewFileId = null;
let draggedFiles = new DataTransfer();

// DOM加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    initializeFileInput();
    
    // 只有在元素存在时才调用
    if (document.getElementById('configureBtn')) {
        updateSelectedFiles();
    }
});

// 初始化拖拽功能
function initializeDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('files');
    
    if (!dropZone || !fileInput) return;
    
    let dragCounter = 0; // 解决拖拽闪烁问题
    
    // 点击拖拽区域打开文件选择
    dropZone.addEventListener('click', function() {
        fileInput.click();
    });
    
    // 阻止默认的拖拽行为
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // 优化的拖拽进入事件
    dropZone.addEventListener('dragenter', function(e) {
        e.preventDefault();
        dragCounter++;
        if (dragCounter === 1) {
            dropZone.classList.add('dragover');
        }
    });
    
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
    });
    
    // 优化的拖拽离开事件
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dragCounter--;
        if (dragCounter <= 0) {
            dragCounter = 0;
            dropZone.classList.remove('dragover');
        }
    });
    
    // 处理文件放置
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dragCounter = 0;
        dropZone.classList.remove('dragover');
        handleDrop(e);
    });
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleDrop(e) {
    const files = e.dataTransfer.files;
    handleFiles(files);
}

// 初始化文件输入
function initializeFileInput() {
    const fileInput = document.getElementById('files');
    if (!fileInput) return;
    
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });
}

// 处理文件选择
function handleFiles(files) {
    if (!files || files.length === 0) return;
    
    // 获取现有文件列表（如果有的话）
    const fileInput = document.getElementById('files');
    const existingFiles = fileInput ? Array.from(fileInput.files) : [];
    
    // 创建新的DataTransfer对象
    const newDataTransfer = new DataTransfer();
    
    // 先添加现有文件
    existingFiles.forEach(file => {
        newDataTransfer.items.add(file);
    });
    
    // 然后添加新文件（检查是否重复）
    for (let file of files) {
        if (isValidFile(file)) {
            // 检查是否已存在同名文件
            const isDuplicate = existingFiles.some(existingFile => 
                existingFile.name === file.name && existingFile.size === file.size
            );
            
            if (!isDuplicate) {
                newDataTransfer.items.add(file);
            } else {
                console.log(`文件 ${file.name} 已存在，跳过添加`);
            }
        }
    }
    
    // 更新文件输入
    if (fileInput) {
        fileInput.files = newDataTransfer.files;
        draggedFiles = newDataTransfer;
    }
    
    updateFilePreview();
    updateUploadButton();
}

// 验证文件类型和大小
function isValidFile(file) {
    const allowedTypes = ['.xlsx', '.xls', '.csv'];
    const fileExt = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!allowedTypes.includes(fileExt)) {
        alert('文件 ' + file.name + ' 格式不支持，只支持 Excel (.xlsx, .xls) 和 CSV 文件');
        return false;
    }
    
    if (file.size > 100 * 1024 * 1024) {
        alert('文件 ' + file.name + ' 超过 100MB 限制');
        return false;
    }
    
    return true;
}

// 更新文件预览
function updateFilePreview() {
    const preview = document.getElementById('selectedFilesPreview');
    const filesList = document.getElementById('selectedFilesList');
    const fileInput = document.getElementById('files');
    
    if (!preview || !filesList || !fileInput) return;
    
    const files = fileInput.files;
    
    if (files.length === 0) {
        preview.style.display = 'none';
        return;
    }
    
    let html = '';
    let totalSize = 0;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        totalSize += file.size;
        
        const fileIcon = getFileIcon(file.name);
        const fileSize = formatFileSize(file.size);
        
        html += '<div class="selected-file-item">' +
                '<div class="selected-file-info">' +
                '<i class="bi ' + fileIcon + ' selected-file-icon"></i>' +
                '<span class="selected-file-name">' + file.name + '</span>' +
                '<span class="selected-file-size">(' + fileSize + ')</span>' +
                '</div>' +
                '<i class="bi bi-x-circle selected-file-remove" onclick="removeFile(' + i + ')" title="移除文件"></i>' +
                '</div>';
    }
    
    html += '<div class="mt-2 text-muted small">' +
            '<i class="bi bi-info-circle"></i> ' +
            '共 ' + files.length + ' 个文件，总大小：' + formatFileSize(totalSize) +
            '</div>';
    
    filesList.innerHTML = html;
    preview.style.display = 'block';
}

// 移除文件
function removeFile(index) {
    const fileInput = document.getElementById('files');
    if (!fileInput) return;
    
    const newDataTransfer = new DataTransfer();
    const files = fileInput.files;
    
    for (let i = 0; i < files.length; i++) {
        if (i !== index) {
            newDataTransfer.items.add(files[i]);
        }
    }
    
    fileInput.files = newDataTransfer.files;
    draggedFiles = newDataTransfer;
    
    updateFilePreview();
    updateUploadButton();
}

// 清空文件选择
function clearSelectedFiles() {
    const fileInput = document.getElementById('files');
    if (fileInput) {
        fileInput.value = '';
        draggedFiles = new DataTransfer();
    }
    
    updateFilePreview();
    updateUploadButton();
}

// 切换文件夹模式
function toggleFolderMode() {
    const fileInput = document.getElementById('files');
    const folderMode = document.getElementById('folderMode');
    
    if (!fileInput || !folderMode) return;
    
    if (folderMode.checked) {
        fileInput.setAttribute('webkitdirectory', 'true');
        fileInput.setAttribute('directory', 'true');
        fileInput.removeAttribute('multiple');
    } else {
        fileInput.removeAttribute('webkitdirectory');
        fileInput.removeAttribute('directory');
        fileInput.setAttribute('multiple', 'true');
    }
    
    // 清空当前选择
    clearSelectedFiles();
}

// 更新上传按钮状态
function updateUploadButton() {
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('files');
    
    if (!uploadBtn || !fileInput) return;
    
    const hasFiles = fileInput.files.length > 0;
    uploadBtn.disabled = !hasFiles;
    
    if (hasFiles) {
        uploadBtn.innerHTML = '<i class="bi bi-upload"></i> 上传 ' + fileInput.files.length + ' 个文件';
    } else {
        uploadBtn.innerHTML = '<i class="bi bi-upload"></i> 上传文件';
    }
}

// 获取文件图标
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'csv':
            return 'bi-file-earmark-text';
        case 'xlsx':
        case 'xls':
            return 'bi-file-earmark-spreadsheet';
        default:
            return 'bi-file-earmark';
    }
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 表单提交处理
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('files');
    const files = fileInput.files;
    
    if (files.length === 0) {
        e.preventDefault();
        alert('请选择要上传的文件');
        return;
    }
    
    // 检查文件大小
    let totalSize = 0;
    for (let file of files) {
        totalSize += file.size;
        if (file.size > 100 * 1024 * 1024) {
            e.preventDefault();
            alert('文件 ' + file.name + ' 超过 100MB 限制');
            return;
        }
    }
    
    if (totalSize > 500 * 1024 * 1024) {
        e.preventDefault();
        alert('总文件大小超过 500MB 限制');
        return;
    }
    
    // 显示上传进度
    const progress = document.getElementById('uploadProgress');
    const btn = document.getElementById('uploadBtn');
    
    if (progress) progress.style.display = 'block';
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 上传中...';
    }
});

// 切换全选
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.file-checkbox');
    
    if (!selectAll || checkboxes.length === 0) return;
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedFiles();
}

// 更新选中文件
function updateSelectedFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox:checked');
    selectedFiles = Array.from(checkboxes).map(cb => cb.value);
    
    const configureBtn = document.getElementById('configureBtn');
    if (!configureBtn) return;
    
    if (selectedFiles.length > 0) {
        configureBtn.disabled = false;
        configureBtn.innerHTML = '<i class="bi bi-gear"></i> 配置选中文件 (' + selectedFiles.length + ')';
    } else {
        configureBtn.disabled = true;
        configureBtn.innerHTML = '<i class="bi bi-gear"></i> 配置选中文件';
    }
}

// 监听复选框变化
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('file-checkbox')) {
        updateSelectedFiles();
    }
});

// 全选并合并
function selectAllFiles() {
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = true;
        toggleSelectAll();
        if (selectedFiles.length > 0) {
            configureSelectedFiles();
        }
    }
}

// 配置选中文件
function configureSelectedFiles() {
    if (selectedFiles.length === 0) {
        alert('请先选择要处理的文件');
        return;
    }
    
    window.location.href = '/configure?file_ids=' + selectedFiles.join(',');
}

// 预览文件
function previewFile(fileId, filename) {
    currentPreviewFileId = fileId;
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    document.querySelector('#previewModal .modal-title').innerHTML = 
        '<i class="bi bi-eye"></i> 文件预览 - ' + filename;
    
    // 获取文件信息并填充工作表选项
    fetch('/api/preview/' + fileId)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePreviewSheetOptions(fileId);
                modal.show();
            } else {
                alert('预览失败：' + data.error);
            }
        })
        .catch(error => {
            alert('预览失败：' + error.message);
        });
}

// 更新工作表选项
function updatePreviewSheetOptions(fileId) {
    const fileRow = document.querySelector('input[value="' + fileId + '"]');
    if (!fileRow) return;
    
    const rowElement = fileRow.closest('tr');
    if (!rowElement) return;
    
    const sheetsCell = rowElement.cells[3];
    if (!sheetsCell) return;
    
    const sheetsText = sheetsCell.textContent;
    
    const sheetSelect = document.getElementById('previewSheet');
    if (!sheetSelect) return;
    
    sheetSelect.innerHTML = '';
    
    if (sheetsText.includes('CSV')) {
        sheetSelect.innerHTML = '<option value="">CSV</option>';
    } else {
        sheetSelect.innerHTML = '<option value="">Sheet1</option>';
    }
    
    updatePreview();
}

// 更新预览
function updatePreview() {
    if (!currentPreviewFileId) return;
    
    const sheetName = document.getElementById('previewSheet').value;
    const headerRow = document.getElementById('previewHeaderRow').value;
    const rows = document.getElementById('previewRows').value;
    
    const url = '/api/preview/' + currentPreviewFileId + '?' + 
                new URLSearchParams({
                    sheet_name: sheetName,
                    header_row: headerRow,
                    rows: rows
                });
    
    document.getElementById('previewContent').innerHTML = 
        '<div class="text-center">' +
        '<div class="spinner-border" role="status">' +
        '<span class="visually-hidden">加载中...</span>' +
        '</div>' +
        '</div>';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPreviewData(data.data);
            } else {
                document.getElementById('previewContent').innerHTML = 
                    '<div class="alert alert-danger">预览失败：' + data.error + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('previewContent').innerHTML = 
                '<div class="alert alert-danger">预览失败：' + error.message + '</div>';
        });
}

// 显示预览数据
function displayPreviewData(data) {
    if (!data || !data.data || data.data.length === 0) {
        document.getElementById('previewContent').innerHTML = 
            '<div class="alert alert-warning">没有数据可预览</div>';
        return;
    }
    
    const columns = data.columns;
    const rows = data.data;
    
    let html = '<div class="mb-2">' +
        '<small class="text-muted">' +
        '共 ' + data.total_rows + ' 行，' + data.total_columns + ' 列' +
        '</small>' +
        '</div>' +
        '<div class="table-responsive">' +
        '<style>' +
        '.preview-table-index {' +
        '    white-space: nowrap;' +
        '    table-layout: fixed;' +
        '    width: 100%;' +
        '}' +
        '.preview-table-index th, .preview-table-index td {' +
        '    max-width: 200px;' +
        '    overflow: hidden;' +
        '    text-overflow: ellipsis;' +
        '    white-space: nowrap;' +
        '    padding: 4px 8px;' +
        '    border: 1px solid #dee2e6;' +
        '}' +
        '.preview-table-index th {' +
        '    position: sticky;' +
        '    top: 0;' +
        '    background-color: #f8f9fa;' +
        '    z-index: 10;' +
        '    font-weight: 600;' +
        '}' +
        '</style>' +
        '<table class="table table-sm table-bordered preview-table-index">' +
        '<thead class="table-light">' +
        '<tr>';
    
    columns.forEach((col, index) => {
        const width = Math.max(120, Math.min(200, col.length * 10 + 50));
        html += '<th style="width: ' + width + 'px;" title="' + col + '">' + col + '</th>';
    });
    html += '</tr></thead><tbody>';
    
    rows.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
            const value = String(row[col] || '');
            const displayValue = value.length > 25 ? value.substring(0, 25) + '...' : value;
            html += '<td title="' + value.replace(/"/g, '&quot;') + '">' + displayValue + '</td>';
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    
    document.getElementById('previewContent').innerHTML = html;
}

// 删除文件
function deleteFile(fileId, filename) {
    if (!confirm('确定要删除文件 "' + filename + '" 吗？')) {
        return;
    }
    
    fetch('/api/delete_file/' + fileId, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('删除失败：' + data.error);
            }
        })
        .catch(error => {
            alert('删除失败：' + error.message);
        });
}

// 清理所有文件
// 清理所有文件
function clearAllFiles() {
    // 直接调用API而不依赖页面显示的文件数量
    if (!confirm('确定要清理所有文件吗？\n\n此操作不可恢复！')) {
        return;
    }
    
    const clearBtn = document.getElementById('clearAllBtn');
    const originalText = clearBtn.innerHTML;
    clearBtn.disabled = true;
    clearBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 清理中...';
    
    fetch('/api/clear_all_files', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'  // 确保发送cookies
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('清理失败：' + data.error);
        }
    })
    .catch(error => {
        alert('清理失败：' + error.message);
    })
    .finally(() => {
        clearBtn.disabled = false;
        clearBtn.innerHTML = originalText;
    });
}
</script>
{% endblock %}